{% extends "base.html" %}

{% block title %}Dashboard - XUI Panel Manager{% endblock %}

{% block body %}
<nav class="navbar">
    <div class="container">
        <a href="/" class="navbar-brand">ğŸ“Š XUI Panel Manager</a>
        <ul class="navbar-nav">
            <li><a href="/dashboard" class="active">Dashboard</a></li>
            <li><a href="/clients">Clients</a></li>
            <li><a href="/packages">Packages</a></li>
            <li><a href="/servers">Servers</a></li>
            <li><a href="/settings">Settings</a></li>
            <li><a href="/logout" style="color: var(--danger);">Logout</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    <h1 style="margin-bottom: 30px;">ğŸ“Š Dashboard</h1>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon primary">ğŸ‘¥</div>
            <div class="stat-content">
                <h3>{{ stats.total_clients }}</h3>
                <p>Total Clients</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon success">âœ…</div>
            <div class="stat-content">
                <h3>{{ stats.active_clients }}</h3>
                <p>Active Clients</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon danger">âŒ</div>
            <div class="stat-content">
                <h3>{{ stats.expired_clients }}</h3>
                <p>Expired Clients</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon warning">âš ï¸</div>
            <div class="stat-content">
                <h3>{{ stats.expiring_soon }}</h3>
                <p>Expiring Soon (7d)</p>
            </div>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon primary">ğŸ–¥ï¸</div>
            <div class="stat-content">
                <h3>{{ stats.total_servers }}</h3>
                <p>Connected Servers</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon success">ğŸ“¦</div>
            <div class="stat-content">
                <h3>{{ stats.total_packages }}</h3>
                <p>Available Packages</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon warning">â¬†ï¸</div>
            <div class="stat-content">
                <h3>{{ stats.total_used_gb }} GB</h3>
                <p>Total Traffic Used</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon primary">ğŸ’¾</div>
            <div class="stat-content">
                <h3>{{ stats.total_quota_gb }} GB</h3>
                <p>Total Quota</p>
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2>ğŸ”„ Quick Actions</h2>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="triggerSync()">
                <span id="syncBtnText">Run Sync Now</span>
            </button>
            <a href="/clients" class="btn btn-success">Manage Clients</a>
            <a href="/packages" class="btn btn-warning">Manage Packages</a>
            <a href="/servers" class="btn" style="background: #9b59b6; color: white;">Manage Servers</a>
        </div>
    </div>
    
    <div class="card">
        <h2>ğŸ“‹ Recent Activity</h2>
        <div id="recentLogs" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <p style="color: #7f8c8d;">Loading logs...</p>
        </div>
    </div>
</div>

<script>
async function triggerSync() {
    const btn = document.querySelector('button');
    const originalText = btn.innerHTML;
    showLoading(btn);
    
    try {
        const response = await fetch('/api/sync/trigger', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('Synchronization started! Check logs for progress.', 'success');
        } else {
            showAlert('Failed to trigger sync: ' + data.message, 'danger');
        }
    } catch (error) {
        showAlert('Error: ' + error.message, 'danger');
    } finally {
        hideLoading(btn, originalText);
    }
}

async function loadLogs() {
    try {
        const response = await fetch('/api/logs');
        const data = await response.json();
        
        const logsDiv = document.getElementById('recentLogs');
        if (data.logs && data.logs.length > 0) {
            logsDiv.innerHTML = data.logs.slice(-20).map(log => {
                let color = '#2c3e50';
                if (log.includes('[SUCCESS]')) color = '#2ecc71';
                else if (log.includes('[ERROR]')) color = '#e74c3c';
                else if (log.includes('[WARN]')) color = '#f39c12';
                
                return `<div style="color: ${color}; margin-bottom: 5px;">${log}</div>`;
            }).join('');
        } else {
            logsDiv.innerHTML = '<p style="color: #7f8c8d;">No logs available yet.</p>';
        }
    } catch (error) {
        console.error('Failed to load logs:', error);
    }
}

// Load logs on page load
loadLogs();

// Refresh logs every 10 seconds
setInterval(loadLogs, 10000);
</script>
{% endblock %}
